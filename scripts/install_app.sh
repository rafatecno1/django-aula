#!/bin/bash
# install_app.sh
# Script Maestro de Instalaci√≥n (Debe ejecutarse con sudo)


# --- CONFIGURACI√ìN DE DIRECTORIOS I USUARIOS PARA LA INSTALACI√ìN DE DJANGO-AULA ---
echo "--- CONFIGURACI√ìN DE DIRECTORIOS I USUARIOS PARA LA INSTALACI√ìN DE DJANGO-AULA ---"
echo -e "--- Este archivo de ejecutarse con sudo ---\n"

#REPO_URL="https://github.com/ctrl-alt-d/django-aula.git"	#repositorio original del proyecto
REPO_URL="https://github.com/rafatecno1/django-aula.git"	#repositorio copiado para hacere las mejoras en privado

read -p "Introduce el nombre del DIRECTORIO (CARPETA) del proyecto (por defecto: djau): " PROJECT_FOLDER

if [ -z "$PROJECT_FOLDER" ]; then
	PROJECT_FOLDER="djau"
    echo "Por defecto, el nombre del directorio ser√° '$PROJECT_FOLDER'."
fi

INSTALL_DIR="/opt"
FULL_PATH="$INSTALL_DIR/$PROJECT_FOLDER"
echo -e "La ruta completa de instalaci√≥n ser√† '$FULL_PATH'.\n"
echo -e "------------\n"


read -p "Introduce el nombre del USUARIO que instalar√° la aplicaci√≥n. El usuario debe existir y tener permisos de sudo (grupo sudoers) (por defecto: djau): " APP_USER

if [ -z "$APP_USER" ]; then
	APP_USER="djau"
    echo "Por defecto, el nombre del usuario que instalar√† la aplicaci√≥n ser√° '$APP_USER'."
fi

# Verifica si el usuario existe antes de continuar
if ! id -u "$APP_USER" >/dev/null 2>&1; then
    echo "ERROR: El usuario '$APP_USER' no existe en el sistema. Debe crearlo antes de continuar y asegurarse que tenga persmisos de sudo."
    exit 1
fi

echo -e "El nombre del usuario que efectuar√° la instalaci√≥n ser√† '$APP_USER'.\n"
echo -e "------------\n"



read -p "Introduce el nombre del DIRECTORIO donde se guardar√°n los datos privados (como las fotograf√≠as del alumnado) (por defecto: djau-dades-privades): " DADES_PRIVADES

if [ -z "$DADES_PRIVADES" ]; then
	DADES_PRIVADES="djau-dades-privades"
    echo "Por defecto, el nombre del directorio ser√° '$DADES_PRIVADES'."
fi

PATH_DADES_PRIVADES="$INSTALL_DIR/$DADES_PRIVADES"
export PATH_DADES_PRIVADES
echo -e "La ruta completa para el directorio donde se guardar√°n los datos privados ser√† '$PATH_DADES_PRIVADES'.\n"
echo -e "------------\n"

# -----------------------------------

echo "--- 3.b: Configurando Permisos NOPASSWD para PostgreSQL ---"

PSQL_PATH="/usr/bin/psql" # Usamos la ruta absoluta m√°s com√∫n

# 1. Definir la regla completa
# Creamos un archivo de reglas espec√≠fico para el usuario djau
# Esto es m√°s seguro que modificar el archivo /etc/sudoers directamente
SUDOERS_RULE="/etc/sudoers.d/90-djau-psql"
PSQL_RULE="$APP_USER ALL=(postgres) NOPASSWD: $PSQL_PATH"

# 2. Concedemos a djau permiso para ejecutar el comando 'psql' como el usuario 'postgres' sin contrase√±a
# Escribir la regla de forma segura. 'printf' es m√°s seguro que 'echo' para evitar problemas de formato y saltos de l√≠nea
printf "%s\n" "$PSQL_RULE" | sudo tee $SUDOERS_RULE > /dev/null

# 3. Asegurar los permisos seguros para el archivo sudoers
sudo chmod 0440 $SUDOERS_RULE

echo -e "‚úÖ Permiso NOPASSWD configurado para el usuario '$APP_USER' para psql.\n"

# -----------------------------------

echo -e "--- INICIO DE INSTALACI√ìN DE DJANGO-AULA ---\n"

# 1. INSTALAR DEPENDENCIAS (Paso 1)
echo -e "1/5: Instalando dependencias del sistema...\n"
apt update && apt install -y python3 python3-venv libxml2-dev libxslt-dev python3-lxml python3-libxml2 python3-dev lib32z1-dev git libgl1 libglib2.0-0t64 postgresql
if [ $? -ne 0 ]; then
    echo "‚ùå ERROR: Fallo en la instalaci√≥n de dependencias. Saliendo."
    exit 1
fi
echo -e "‚úÖ Dependencias instaladas.\n"

# 2. CREAR CARPETAS Y ASIGNAR PERMISOS (Paso 2)
echo -e "2/5: Creando directorio '$FULL_PATH' y ajustando permisos...\n"
mkdir -p "$FULL_PATH"
if [ ! -d "$FULL_PATH" ]; then
    echo "‚ùå ERROR: No se pudo crear el directorio '$FULL_PATH'. Saliendo."
    exit 1
fi

mkdir -p "$PATH_DADES_PRIVADES"
if [ ! -d "$PATH_DADES_PRIVADES" ]; then
    echo "‚ùå ERROR: No se pudo crear el directorio '$PATH_DADES_PRIVADES'. Saliendo."
    exit 1
fi

# Asignar la propiedad al usuario de la aplicaci√≥n.
chown -R "$APP_USER":"$APP_USER" "$FULL_PATH"
echo -e "‚úÖ Directorio '$FULL_PATH' creado y permisos asignados a usuario '$APP_USER' y grupo '$APP_USER'.\n"

chown -R "$APP_USER":www-data "$PATH_DADES_PRIVADES"
chmod 770 "$PATH_DADES_PRIVADES"
echo -e "‚úÖ Directorio '$PATH_DADES_PRIVADES' creado y permisos asignados a usuario '$APP_USER' y grupo www-data.\n"

# 3. CLONAR REPOSITORIO (Paso 3)
echo -e "3/5: Clonando repositorio. Esto se har√° como el usuario '$APP_USER'...\n"

# Usamos su para clonar como el usuario de la aplicaci√≥n
sudo -u "$APP_USER" git clone "$REPO_URL" "$FULL_PATH"
if [ $? -ne 0 ]; then
    echo "‚ùå ERROR: Fallo al clonar el repositorio '$REPO_URL'. Comprueba que la URL ('$FULL_PATH') sea correcta y los permisos."
    exit 1
fi
echo -e "‚úÖ Repositorio clonado en '$FULL_PATH'.\n"

# 4. DELEGAR AL SCRIPT DE CONFIGURACI√ìN DE DJANGO (Paso 4 en adelante)
echo "4/5: Ejecutando el script de configuraci√≥n de la aplicaci√≥n..."
echo -e "Esto se ejecutar√° como el usuario '$APP_USER' para manejar el venv y manage.py.\n"

# Transfiere la ejecuci√≥n al script de configuraci√≥n de Django DENTRO del repositorio clonado
cd "$FULL_PATH"
chmod +x setup_djau.sh
sudo -u "$APP_USER" bash setup_djau.sh "$PATH_DADES_PRIVADES" # Asumiendo que setup_django.sh est√° a la subcarpeta raiz

if [ $? -ne 0 ]; then
    echo "‚ùå ERROR: Fallo en el script de configuraci√≥n de Django. Revisa los logs."
    exit 1
fi

echo "--- üü¢ INSTALACI√ìN B√ÅSICA FINALIZADA üü¢ ---"
echo "5/5: La aplicaci√≥n est√° configurada. Sigue las instrucciones para Apache y CRON."