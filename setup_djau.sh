#!/bin/bash
# setup_djau.sh
# Configura el entorno virtual, la base de datos PostgreSQL, 
# y personaliza el archivo settings_local.py para la aplicaci√≥n Django.
# DEBE EJECUTARSE como el usuario de la aplicaci√≥n (djau).

echo -e "\n"
echo "====================================================================="
echo "--- üü¢ INICIO DEL SCRIPT: setup_djau.sh (Configuraci√≥n Django) üü¢ ---"
echo "====================================================================="
echo -e "\n"

# ----------------------------------------------------------------------
# FUNCIONES DE AYUDA Y VALIDACI√ìN
# ----------------------------------------------------------------------

# Funci√≥n para leer la entrada de datos del usuario y asegurar que no deja 
# respuestas en blanco ni con espacios delante o detr√°s.
# Uso: read_and_validate "Mensaje de la pregunta" VARIABLE_NAME
read_and_validate () {
    # $1 contiene el mensaje (prompt), $2 contiene el nombre de la variable (sin $)
    local PROMPT_MSG="$1"
    local VAR_NAME="$2"
    local INPUT_VALUE=""
    
    # Bucle de validaci√≥n: se repite hasta obtener una respuesta no vac√≠a
    while true; do
        read -p "$PROMPT_MSG" INPUT_VALUE
        
        # Eliminar espacios en blanco alrededor (trim)
        INPUT_VALUE=$(echo "$INPUT_VALUE" | xargs)
        
        if [ -z "$INPUT_VALUE" ]; then
            echo -e "‚ùå ERROR: Este campo no puede dejarse en blanco.\n"
        else
            # Asignar el valor a la variable cuyo nombre se pas√≥ como argumento ($2)
            eval "$VAR_NAME='$INPUT_VALUE'"
            break
        fi
    done
}

# ----------------------------------------------------------------------
# 1. PREPARACI√ìN DEL ENTORNO Y BASE DE DATOS
# ----------------------------------------------------------------------

echo "==================================================================="
echo "--- üìù 1. CONFIGURACI√ìN DE PAR√ÅMETROS DE LA BASE DE DATOS Y APP ---"
echo "==================================================================="
echo -e "\n"

# 1.1 Capturar la ruta de datos privados (Pasada por el script padre)
PATH_DADES_PRIVADES="$1"

if [ -z "$PATH_DADES_PRIVADES" ]; then
    echo "‚ùå ERROR: No se recibi√≥ la ruta de datos privados (Argumento \$1). Saliendo."
    exit 1
fi
echo "‚òëÔ∏è Ruta de datos privados recibida del script install_app.sh: $PATH_DADES_PRIVADES"
echo -e "\n"


# 1.2 Solicitud de Par√°metros de la Base de Datos
echo "--- 1.2 Solicitud de Par√°metros de PostgreSQL ---"
echo -e "\n"

# La funci√≥n read_and_validate ya no permite dejar campos en blanco.
read_and_validate "Introduzca el NOMBRE de la BASE DE DATOS (ej: djau_db): " DB_NAME
read_and_validate "Introduzca el USUARIO de la BD (ej: djau): " DB_USER

# Validaci√≥n de contrase√±as
while true; do
    read -sp "Introduzca la CONTRASE√ëA para el usuario $DB_USER de la BD: " DB_PASS
    echo
    read -sp "Repita la CONTRASE√ëA: " DB_PASS2
    echo 

    if [ -z "$DB_PASS" ] || [ -z "$DB_PASS2" ]; then
        echo -e "‚ùå ERROR: La contrase√±a no puede dejarse en blanco. Int√©ntelo de nuevo.\n"
    elif [ "$DB_PASS" != "$DB_PASS2" ]; then
        echo -e "‚ùå ERROR: Las contrase√±as no coinciden. Int√©ntelo de nuevo.\n"
    else
        break
    fi
done
echo -e "\n"
echo "‚òëÔ∏è Par√°metros de la Base de Datos definidos."
echo -e "\n"
sleep 3

# ----------------------------------------------------------------------
# 2. CONFIGURACI√ìN DEL ENTORNO VIRTUAL Y CLAVE SECRETA
# ----------------------------------------------------------------------

echo "======================================================="
echo "--- ‚öôÔ∏è 2. PREPARACI√ìN DEL ENTORNO VIRTUAL DE DJANGO ---"
echo "======================================================="
echo -e "\n"

echo -e "--- 2.1 Creando Entorno Virtual (venv) e instalando dependencias ---\n"

python3 -m venv venv
source venv/bin/activate

pip install --upgrade pip wheel
pip install -r requirements.txt

if [ $? -ne 0 ]; then
    echo "‚ùå ERROR: Fallo al instalar las dependencias de Python. Saliendo."
    deactivate
    exit 1
fi
echo -e "\n"
echo "‚úÖ Entorno virtual creado y paquetes instalados."
echo -e "\n"
sleep 3

echo "--- 2.2 Generando Clave Secreta de Django ---"

SECRET_KEYPASS=$(python manage.py generate_secret_key 2>&1)

# FILTRO ROBUSTO:
# 1. Usamos 'tr' para reemplazar los caracteres problem√°ticos (|, #, /, &) por un guion (-).
#    Este filtro garantiza que la clave no contendr√° el delimitador que usaremos en sed (|).
SECRET_KEYPASS_FILTERED=$(echo "$SECRET_KEYPASS" | tr '\|#/&' '----')

if [ ${#SECRET_KEYPASS} -lt 32 ]; then
    echo "‚ùå ERROR: No se pudo generar una clave secreta v√°lida. Saliendo."
    deactivate
    exit 1
fi

echo "‚úÖ Clave secreta generada autom√°ticamente."
echo -e "\n"

sleep 3

# ----------------------------------------------------------------------
# 3. CREACI√ìN Y CONFIGURACI√ìN DE POSTGRESQL
# ----------------------------------------------------------------------

echo "=================================================================="
echo "--- üíæ 3. CREACI√ìN Y CONFIGURACI√ìN DE BASE DE DATOS POSTGRESQL ---"
echo "=================================================================="
echo -e "\n"

# Crear el script SQL temporal
SQL_FILE="temp_setup_${DB_NAME}.sql"
cat << EOF > "$SQL_FILE"
DROP DATABASE IF EXISTS $DB_NAME;
DROP ROLE IF EXISTS $DB_USER;
CREATE DATABASE $DB_NAME;
CREATE USER $DB_USER WITH PASSWORD '$DB_PASS';
GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER;
ALTER DATABASE $DB_NAME OWNER TO $DB_USER;
EOF

echo "--- Ejecutando Script SQL con 'psql' (NOPASSWD) ---"

# Se ejecuta con NOPASSWD configurado en el script padre, la salida se redirige a /dev/null
sudo -u postgres psql -t -f "$SQL_FILE" > /dev/null 2>&1 

if [ $? -ne 0 ]; then
    echo "‚ùå ERROR: Fallo al configurar PostgreSQL. Revisa la regla NOPASSWD o la sintaxis SQL."
    rm "$SQL_FILE"
    deactivate
    exit 1
fi
rm "$SQL_FILE"
echo -e "\n"
echo "‚úÖ Base de datos '$DB_NAME' y usuario '$DB_USER' creados correctamente."
echo -e "\n"
sleep 3

# ----------------------------------------------------------------------
# 4. PERSONALIZACI√ìN DEL ARCHIVO settings_local.py
# ----------------------------------------------------------------------

echo "==========================================================="
echo "--- üìù 4. PERSONALIZACI√ìN DEL ARCHIVO settings_local.py ---"
echo "==========================================================="
echo -e "\n"

# --- 4.1 Solicitud de Par√°metros de la Aplicaci√≥n (Usuario) ---
echo "--- 4.1 Par√°metros de la Aplicaci√≥n ---"
echo -e "\n"

read_and_validate "Introduzca el nombre del CENTRO EDUCATIVO (ej: Centre de Demo): " NOM_CENTRE
read_and_validate "Introduzca la LOCALIDAD del centro educativo (ej: Badia del Vall√©s): " LOCALITAT
read_and_validate "Introduzca el C√ìDIGO del centro (ej: 00000000): " CODI_CENTRE
read_and_validate "Introduzca la URL base de la aplicaci√≥n (ej: https://elteudomini.cat): " URL_BASE
read_and_validate "Introduzca los HOSTS permitidos separados por comas. (ej: elteudomini.cat,127.0.0.1): " ALLOWED_HOSTS_LIST
read_and_validate "Introduzca la direcci√≥n de CORREO del administrador (ej: ui@mega.cracs.cat): " ADMIN_EMAIL
echo -e "\n"
echo -e "‚òëÔ∏è Par√°metros generales definidos.\n"
echo -e "\n"

echo "--- 4.2 Par√°metros de Correo SMTP (Google/App Password) ---"
echo "‚ÑπÔ∏è  Para el env√≠o de correos se requiere una contrase√±a de aplicaci√≥n de Google."
echo -e "    La informaci√≥n se puede encontrar aqu√≠: https://support.google.com/mail/answer/185833?hl=ca\n"

read_and_validate "Introduzca el CORREO para env√≠o SMTP (EMAIL_HOST_USER): " EMAIL_HOST_USER
read_and_validate "Introduzca la CONTRASE√ëA de aplicaci√≥n SMTP (EMAIL_HOST_PASSWORD): " EMAIL_HOST_PASS
read_and_validate "Introduzca el CORREO del servidor (SERVER_EMAIL/DEFAULT_FROM_EMAIL): " SERVER_MAIL
echo -e "\n"
echo -e "‚òëÔ∏è Par√°metros SMTP definidos.\n"
echo -e "\n"


# 4.3 Copiar y Aplicar Sustituciones
CONFIG_FILE="aula/settings_local.sample"
FINAL_FILE="aula/settings_local.py"

if [ ! -f "$CONFIG_FILE" ]; then
    echo "‚ùå ERROR: No se encontr√≥ el archivo sample en '$CONFIG_FILE'. Saliendo."
    deactivate
    exit 1
fi
cp "$CONFIG_FILE" "$FINAL_FILE"

echo "--- 4.3 Aplicando Sustituciones con 'sed' ---"

# Base de Datos
sed -i "s#^        'NAME': 'djau2025',#        'NAME': '$DB_NAME',#" "$FINAL_FILE"
sed -i "s#^        'USER': 'djau2025',#        'USER': '$DB_USER',#" "$FINAL_FILE"
sed -i "s#^        'PASSWORD': \"XXXXXXXXXX\",#        'PASSWORD': \"$DB_PASS\",#" "$FINAL_FILE"

# Variables de la aplicaci√≥n:
sed -i "s#^NOM_CENTRE = 'Centre de Demo'#NOM_CENTRE = u'$NOM_CENTRE'#" "$FINAL_FILE"
sed -i "s#^LOCALITAT = u\"Badia del Vall√©s\"#LOCALITAT = u\"$LOCALITAT\"#" "$FINAL_FILE"
sed -i "s#^CODI_CENTRE = u\"00000000\"#CODI_CENTRE = u\"$CODI_CENTRE\"#" "$FINAL_FILE"
sed -i "s#^URL_DJANGO_AULA = r'http://elteudomini.cat'#URL_DJANGO_AULA = r'$URL_BASE'#" "$FINAL_FILE"

# ALLOWED_HOSTS
ALLOWED_HOSTS_PYTHON_LIST="'${ALLOWED_HOSTS_LIST//,/\', \'}'"
sed -i "s#^ALLOWED_HOSTS = \[ 'elteudomini.cat', '127.0.0.1', \]#ALLOWED_HOSTS = [ $ALLOWED_HOSTS_PYTHON_LIST, ]#" "$FINAL_FILE"

# Clave Secreta y Datos Privados
sed -i "s|^SECRET_KEY = .*|SECRET_KEY = '$SECRET_KEYPASS_FILTERED'|" "$FINAL_FILE"
sed -i "s#^PRIVATE_STORAGE_ROOT =.*#PRIVATE_STORAGE_ROOT = '$PATH_DADES_PRIVADES'#" "$FINAL_FILE"

# Datos de Email/Admin
sed -i "s#('admin', 'ui@mega.cracs.cat'),#('admin', '$ADMIN_EMAIL'),#" "$FINAL_FILE"
sed -i "s#^EMAIL_HOST_USER='el-meu-centre@el-meu-centre.net'#EMAIL_HOST_USER='$EMAIL_HOST_USER'#" "$FINAL_FILE"
sed -i "s#^EMAIL_HOST_PASSWORD='xxxx xxxx xxxx xxxx'#EMAIL_HOST_PASSWORD='$EMAIL_HOST_PASS'#" "$FINAL_FILE"
sed -i "s#^SERVER_EMAIL='el-meu-centre@el-meu-centre.net'#SERVER_EMAIL='$SERVER_MAIL'#" "$FINAL_FILE"
sed -i "s#^DEFAULT_FROM_EMAIL = 'El meu centre <no-reply@el-meu-centre.net>'#DEFAULT_FROM_EMAIL = '$NOM_CENTRE <$SERVER_MAIL>'#" "$FINAL_FILE"
sed -i "s/EMAIL_SUBJECT_PREFIX = .*/EMAIL_SUBJECT_PREFIX = '[Comunicaci√≥ $NOM_CENTRE]'/" "$FINAL_FILE"

# Forzar SSL en cookies si la URL es HTTPS (se asume que s√≠)
sed -i "s/^SESSION_COOKIE_SECURE=False/SESSION_COOKIE_SECURE=True/" "$FINAL_FILE"
sed -i "s/^CSRF_COOKIE_SECURE=False/CSRF_COOKIE_SECURE=True/" "$FINAL_FILE"

echo "‚úÖ settings_local.py configurado y personalizado."
echo -e "\n"
sleep 3

# ----------------------------------------------------------------------
# 5. MIGRACIONES Y CONFIGURACI√ìN DE USUARIOS
# ----------------------------------------------------------------------

echo "=================================================================="
echo "--- üîÑ 5. APLICACI√ìN DE MIGRACIONES Y CONFIGURACI√ìN DE USUARIO ---"
echo "=================================================================="
echo -e "\n"

echo -e "--- 5.1 Aplicando Migraciones de Base de Datos ---\n"
python manage.py migrate --noinput

if [ $? -ne 0 ]; then
    echo "‚ùå ERROR: Fallo al aplicar las migraciones. Revisa la conexi√≥n a la Base de Datos."
    deactivate
    exit 1
fi
echo -e "\n"
echo "‚úÖ Migraciones aplicadas correctamente."
echo -e "\n"
sleep 3

echo -e "--- 5.2 Ejecutando 'scripts/fixtures.sh' (si existe) ---\n"
if [ -f "scripts/fixtures.sh" ]; then
    bash scripts/fixtures.sh
	echo -e "\n"
    if [ $? -ne 0 ]; then
        echo "‚ùå Advertencia: Fallo al ejecutar 'scripts/fixtures.sh'."
    fi
    echo -e "‚úÖ Fixtures ejecutados.\n"
else
    echo -e "‚òëÔ∏è scripts/fixtures.sh no encontrado. Paso omitido.\n"
fi
echo -e "\n"
sleep 3

echo "--- 5.3 Creaci√≥n de Superusuario 'admin' en la aplicaci√≥n DJANGO ---"
echo -e "\n"
echo "‚ö†Ô∏è  ATENCI√ìN: Se abrir√° el modo interactivo para crear el superusuario 'admin'."
echo -e "   Por favor, utiliza el nombre de usuario 'admin', en vez del que el sistema sugiere por defecto, y una contrase√±a segura.\n"
python manage.py createsuperuser
sleep 3

echo -e "\n"
echo "--- 5.4 Creando Grupos y asignando a 'admin' ---"

PYTHON_SCRIPT="temp_setup_groups.py"
cat << EOF > "$PYTHON_SCRIPT"
from django.contrib.auth.models import User, Group
try:
    g1, _ = Group.objects.get_or_create( name = 'direcci√≥' )
    g2, _ = Group.objects.get_or_create( name = 'professors' )
    g3, _ = Group.objects.get_or_create( name = 'professional' )
    admin_user = User.objects.get( username = 'admin' )
    admin_user.groups.set( [ g1, g2, g3 ] )
    admin_user.save()
    print("‚úÖ Grupos creados y asignados al usuario 'admin' correctamente.")
except Exception as e:
    print(f"‚ùå Error al configurar grupos: {e}")
    exit(1)
EOF

python manage.py shell < "$PYTHON_SCRIPT" > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "‚ùå Error al ejecutar el script de configuraci√≥n de grupos."
fi
rm "$PYTHON_SCRIPT"
echo -e "\n"
echo "‚úÖ Grupos configurados."
echo -e "\n"
sleep 3

# ----------------------------------------------------------------------
# 6. RECOLECCI√ìN DE EST√ÅTICOS Y FINALIZACI√ìN
# ----------------------------------------------------------------------

echo "==============================================="
echo "--- üñºÔ∏è 6. RECOLECCI√ìN DE ARCHIVOS EST√ÅTICOS ---"
echo "==============================================="
#echo -e "\n"

python manage.py collectstatic -c --no-input

if [ $? -ne 0 ]; then
    echo "‚ùå ERROR: Fallo al recolectar archivos est√°ticos."
    deactivate
    exit 1
fi
echo -e "\n"
echo "‚úÖ Archivos est√°ticos recolectados."
echo -e "\n"

deactivate
sleep 3


echo "========================================================================================="
echo "--- üü¢ CONFIGURACI√ìN B√ÅSICA GESTIONADA PARA DJANGO-AULA COMPLETADA (setup_djau.sh) üü¢ ---"
echo "Devolviendo el control al script install_app.sh"
echo "========================================================================================="
echo -e "\n"